#!/bin/bash
  
  readonly prog_name=$(/usr/bin/basename ${0})
  readonly prog_version="2.0"
  
  if [ $# -lt 4 ] || [ $# -gt 4 ]; then
    echo "Error: Invalid arguments"
    echo "  Usage"
    echo "    ${prog_name} \\"
    echo "      --address \"https://jps.example.com:8443\""
    echo "      --credentials \"credentials\"" && exit 1
  fi
  
  positional=()
  
  while [[ $# -gt 0 ]]; do
    key="${1}"
    case "${key}" in
      -a|--address)
      address="$2"
      shift
      shift
      ;;
      -c|--credentials)
      credentials="$2"
      shift
      ;;
      *)
      positional+=("$1")
      shift
      ;;
    esac
  done
  
  set -- "${positional[@]}"
  
  jamf_computers_resource="${address}/JSSResource/computers"
  jamf_devices_resource="${address}/JSSResource/mobiledevices"
  
  curl -fk --header "authorization: Basic ${credentials}" "${jamf_computers_resource}" --header "accept: application/xml" -s | xmllint --format - | awk -F'>|<' '/<id>/,/<\/id>/{print $3}' | sort -n | while read line && [ ! -z "${line}" ]; do
  
    echo "==> Flush faileds commands on computer id '${line}' on '${address}'"
  
    /usr/bin/curl \
      --header "authorization: Basic ${credentials}" \
      --silent \
      -fk \
      "${address}/JSSResource/commandflush/computers/id/${line}/status/Failed" \
      -X DELETE > /dev/null 2>&1
  
  done
  
  curl -fk --header "authorization: Basic ${credentials}" "${jamf_devices_resource}" --header "accept: application/xml" -s | xmllint --format - | awk -F'>|<' '/<id>/,/<\/id>/{print $3}' | sort -n | while read line && [ ! -z "${line}" ]; do
  
    echo "==> Flush faileds commands on mobile device id '${line}' on '${address}'"
  
    /usr/bin/curl \
      --header "authorization: Basic ${credentials}" \
      --silent \
      -fk \
      "${address}/JSSResource/commandflush/mobiledevices/id/${line}/status/Failed" \
      -X DELETE > /dev/null 2>&1
  
  done