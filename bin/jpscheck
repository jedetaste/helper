#!/bin/bash
  
  readonly prog_name=$(basename ${0})
  readonly prog_version="2.0"
  
  function logging() {
    jpscheck_log_file="/var/log/jpscheck.log"
    echo $(/bin/date) "==> $*" >> "${jpscheck_log_file}"
  }
  
  logging "${prog_name} v${prog_version}"
  
  if [ "$(curl -sL -w "%{http_code}" "http://google.com/" -o /dev/null)" == "200" ]; then
    
    # Read general information
    
    jamf_pro_url=$(defaults read /Library/Preferences/com.jamfsoftware.jamf.plist jss_url)
    logging "Jamf Pro URL is '${jamf_pro_url}'"
    
    # Jamf binary missing
    
    if [ ! -s "/usr/local/jamf/bin/jamf" ]; then
      
      if [ ! -d "/usr/local/jamf/bin/" ]; then
        mkdir -p "/usr/local/jamf/bin/"
      fi
      
      curl -so "/usr/local/jamf/bin/jamf.gz" "${jamfProURL}bin/jamf.gz"
      gunzip -fq "/usr/local/jamf/bin/jamf.gz" && chmod +x "/usr/local/jamf/bin/jamf"
      
      if [ ! -d "/usr/local/bin/" ]; then
        mkdir -p "/usr/local/bin/"
      fi
      
      if [ -z $(readlink /usr/local/bin/jamf) ]; then
        ln -s "/usr/local/jamf/bin/jamf" "/usr/local/bin/jamf"
      fi
      
      /usr/local/bin/jamf "manage"
      
    fi
    
    # Jamf binary did not run the last 1 hour
    
    jamf_pro_log_file="/var/log/jamf.log"
    
    defaults write "/Library/Preferences/com.jamfsoftware.jamf.plist" do_not_upgrade_jamf -bool false
        
    if [ $(date -j -v -1H +%s) -gt $(/usr/bin/stat -f "%m%t %Y" ${jamf_pro_log_file}) ]; then
      logging "It seems, that the Jamf Pro binary did not run the last 1 hour"
      killall "jamf" && sleep 5 && /usr/local/bin/jamf "policy"
      exit 0
    else
      logging "Jamf Pro binary is running properly"
      exit 0
    fi
    
  else
    logging "${prog_name} could not be performed, computer seems to be offline" && exit 0
  fi