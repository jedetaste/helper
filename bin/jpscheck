#!/bin/bash
  
  readonly progName=$(/usr/bin/basename ${0})
  readonly progVersion="1.1"
  
  function logging() {
    jpscheckLogFile="/var/log/jpscheck.log"
    echo $(/bin/date) "==> $*" >> "${jpscheckLogFile}"
  }
  
  logging "${progName} v${progVersion}"
  
  if [ "$(/usr/bin/curl -sL -w "%{http_code}" "http://google.com/" -o /dev/null)" == "200" ]; then
    
    jamfProURL=$(/usr/bin/defaults read /Library/Preferences/com.jamfsoftware.jamf.plist jss_url)
    logging "Jamf Pro URL is '${jamfProURL}'"
    
    if [ ! -s "/usr/local/jamf/bin/jamf" ]; then
      
      if [ ! -d "/usr/local/jamf/bin/" ]; then
        /bin/mkdir -p "/usr/local/jamf/bin/"
      fi
      
      /usr/bin/curl -so "/usr/local/jamf/bin/jamf.gz" "${jamfProURL}bin/jamf.gz"
      gunzip -fq "/usr/local/jamf/bin/jamf.gz" && chmod +x "/usr/local/jamf/bin/jamf"
      
      if [ ! -d "/usr/local/bin/" ]; then
        /bin/mkdir -p "/usr/local/bin/"
      fi
      
      if [ -z $(/usr/bin/readlink /usr/local/bin/jamf) ]; then
        /bin/ln -s "/usr/local/jamf/bin/jamf" "/usr/local/bin/jamf"
      fi
      
      /usr/local/bin/jamf "manage"
      
    fi
    
    jamfProLogFile="/var/log/jamf.log"
    
    if [ $(/usr/bin/defaults read "/Library/Preferences/com.jamfsoftware.jamf" do_not_upgrade_jamf) == 1 ]; then
      logging "Jamf Pro binary could be outdated, perform update..."
      /usr/bin/defaults write "/Library/Preferences/com.jamfsoftware.jamf" do_not_upgrade_jamf -bool false
      /usr/bin/killall "jamf" && sleep 5 && /usr/local/bin/jamf "policy"
    else
      logging "Jamf Pro binary seems up-to-date"
    fi

    if [ $(/bin/date -j -v -1H +%s) -gt $(/usr/bin/stat -f "%m%t %Y" $jamfProLogFile) ]; then
      logging "It seems, that the Jamf Pro binary did not run the last 20 minutes"
      /usr/bin/killall "jamf" && sleep 5 && /usr/local/bin/jamf "policy"
      exit 0
    else
      logging "Jamf Pro binary is running properly"
      exit 0
    fi

  else
    logging "${progName} could not be performed, computer seems to be offline"
    exit 0
  fi
