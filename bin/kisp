#!/bin/bash
	
	progname=$(basename $0)
	progversion="1.0"
	
	readonly sourceURI="https://raw.githubusercontent.com/jedetaste/kisp/master"
	
	tmpFolder=$(getconf DARWIN_USER_CACHE_DIR) && randString=$(/usr/bin/openssl rand -hex 5) && tmpDir="${tmpFolder}${randString}" && /bin/mkdir -p "${tmpDir}"
	
	if [ -s "/usr/local/bin/mcxToProfile" ]; then
		rm -f "/usr/local/bin/mcxToProfile"
	fi
	
	/usr/bin/curl -sfko "/usr/local/bin/mcxToProfile" "https://raw.githubusercontent.com/jedetaste/helper/master/bin/MCXToProfile"
	
	/usr/sbin/chown root:wheel "/usr/local/bin/mcxToProfile"
	/bin/chmod 775 "/usr/local/bin/mcxToProfile"
	/bin/chmod +x "/usr/local/bin/mcxToProfile"
	
	domainPlist=(
		'.GlobalPreferences'
		'com.apple.HIToolbox'
		'com.apple.Safari'
		'com.apple.driver.AppleBluetoothMultitouch.mouse'
		'com.apple.driver.AppleBluetoothMultitouch.trackpad'
		'com.apple.driver.AppleHIDMouse'
		'com.apple.sharingd'
		'com.google.Chrome'
		'com.microsoft.Excel'
		'com.microsoft.Outlook'
		'com.microsoft.Powerpoint'
		'com.microsoft.Word'
		'com.microsoft.autoupdate2'
		'com.microsoft.errorreporting'
		'com.microsoft.onenote.mac'
	)
	
	for ((i = 0; i < "${#domainPlist[@]}"; i++)); do
		
		cd "${tmpDir}" && /usr/bin/curl -sOJL "${sourceURI}/${domainPlist[$i]}/${domainPlist[$i]}.plist"
		
		$(which mcxToProfile) \
			--plist "${tmpDir}/${domainPlist[$i]}.plist" \
			--identifier "${domainPlist[$i]}" \
			--organization "anykeyIT" \
			--output "${tmpDir}/${domainPlist[$i]}.mobileconfig"
		
		if /usr/bin/profiles -P | egrep -q "${domainPlist[$i]}"; then
			/usr/bin/profiles -Rp "${domainPlist[$i]}" && sleep 1
		fi
		
		echo "=> Install configuration profile with identifier '${domainPlist[$i]}'"
		/usr/bin/profiles -IF "${tmpDir}/${domainPlist[$i]}.mobileconfig"
		
		rm -f "${tmpDir}/${domainPlist[$i]}.plist"
		rm -f "${tmpDir}/${domainPlist[$i]}.mobileconfig"
		
	done
	
	rm -rf "${tmpDir}"