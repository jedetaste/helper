#!/bin/bash
  
  readonly progName=$(/usr/bin/basename ${0})
  readonly progVersion="1.0"
  
  tmpFolder=$(getconf DARWIN_USER_TEMP_DIR)
  randString=$(/usr/bin/openssl rand -hex 5)
  workDir="${tmpFolder}${randString}"
  /bin/mkdir -p "${workDir}"
  
  expandFolder="${workDir}/expandFolder" && /bin/mkdir -p "${expandFolder}"
  flattenFolder="${workDir}/flattenFolder" && /bin/mkdir -p "${flattenFolder}"
  
  PKGarg="${1}"
  
  if [ ! -z "${1}" ]; then
    echo "Process '${1}'"
  else
    echo "Error: Add PKG path as argument" && exit 1
  fi
  
  /bin/cp -r "${PKGarg}" "${workDir}/"
  
  if [ ! -s $(/usr/bin/find "${workDir}" -name "*.pkg") ]; then
    echo "Error: No PKG found" && exit 1
  else
    PKGFilePath=$(/usr/bin/find "${workDir}" -name "*.pkg") && PKGFile=$(basename "${PKGFilePath}")
  fi
  
  /usr/sbin/pkgutil --expand "${PKGFilePath}" "${expandFolder}/${PKGFile}"
  /usr/sbin/pkgutil --flatten "${expandFolder}/${PKGFile}" "${flattenFolder}/${PKGFile}"
  
  echo "Flat PKG saved at '${flattenFolder}/${PKGFile}'"
  open -R "${flattenFolder}/${PKGFile}"