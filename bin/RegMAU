#!/bin/bash
  
  readonly progName=$(/usr/bin/basename ${0})
  readonly progVersion="1.1"
  
  for user in $(ls /Users | grep -v Shared | grep -v Guest | grep -v '.localized'); do
    if [ -s "/Users/${user}/Library/Preferences/com.microsoft.autoupdate2.plist" ]; then
      rm -f "/Users/${user}/Library/Preferences/com.microsoft.autoupdate2.plist"
    fi
  
    if [ -s "/Users/${user}/Library/Preferences/com.microsoft.autoupdate2.debuglogging.plist" ]; then
      rm -f "/Users/${user}/Library/Preferences/com.microsoft.autoupdate2.debuglogging.plist"
    fi
  
    if [ -s "/Users/${user}/Library/Preferences/com.microsoft.autoupdate.fba.plist" ]; then
      rm -f "/Users/${user}/Library/Preferences/com.microsoft.autoupdate.fba.plist"
    fi
  done
  
  currentUser=$(/usr/local/bin/currentuser)
  
  if [ ! -z "${currentUser}" ]; then
    if [ -d "/Library/Application Support/Microsoft/MAU2.0/Microsoft AutoUpdate.app" ]; then
      /usr/bin/sudo -u ${currentUser} /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -R -f -trusted "/Library/Application Support/Microsoft/MAU2.0/Microsoft AutoUpdate.app"
      /usr/bin/sudo -u ${currentUser} /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -R -f -trusted "/Library/Application Support/Microsoft/MAU2.0/Microsoft AutoUpdate.app/Contents/MacOS/Microsoft AU Daemon.app"
      /usr/bin/sudo -u ${currentUser} defaults write com.microsoft.autoupdate2 StartDaemonOnAppLaunch -bool YES
      echo "Microsoft AutoUpdate registered successfully"
    fi
  fi